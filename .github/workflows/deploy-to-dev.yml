name: Deploy To Development
on: [workflow_dispatch]
jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: development
    steps:
        - uses: actions/checkout@v4

        - name: Set up Python
          uses: actions/setup-python@v2
          with:
            python-version: '3.10'

        - name: Install dependencies
          run: |
            pip install -r ./aggregate-logs-to-parquet/requirements.txt
            pip install awscli

        # - name: Build Aggregate logs to parquet functions
        #   run: |
        #     # docker build -t development-aggregate-logs-to-parquet ./aggregate-logs-to-parquet
        #     docker build --platform linux/amd64 -t development-aggregate-logs-to-parquet ./aggregate-logs-to-parquet
        #     # docker run -i -v ${GITHUB_WORKSPACE}/aggregate-logs-to-parquet:/var/task development-aggregate-logs-to-parquet

        - name: Set File Permissions
          run: |
            chmod 0666 ./aggregate-logs-to-parquet

        - name: Create Aggregate logs to Parquet Archive
          run: |
            sudo -s sh -c 'cd aggregate-logs-to-parquet && zip -r ../aggregate-logs-to-parquet ./*'
            sudo -s sh -c  'pwd'
    
        - name: Upload Aggregate logs to Parquet artifact for deployment job
          uses: actions/upload-artifact@v3
          with:
            name: aggregate-logs-to-parquet
            path: aggregate-logs-to-parquet.zip

        - name: Set up AWS credentials
          uses: aws-actions/configure-aws-credentials@v1-node16
          with:
            aws-access-key-id: ${{ secrets.DEPLOY_AWS_ACCESS_KEY_ID }}
            aws-secret-access-key: ${{ secrets.DEPLOY_AWS_SECRET_ACCESS_KEY }}
            aws-region: eu-west-2
        
        - name: Deploy aws Process log Lambda functions
          run: |
            aws lambda update-function-code --function-name development-aggregate-logs-parquet --zip-file fileb://./aggregate-logs-to-parquet.zip


    
      